
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
      
        <link rel="prev" href="../page5/">
      
      
      
      <link rel="icon" href="../images/logo.png">
      <meta name="generator" content="mkdocs-1.5.3, mkdocs-material-9.5.15">
    
    
      
        <title>Building A Serverless Web Scraper with Layers, Dynamo DB, SNS and Event Bridge - Lambda Forge</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e359304.min.css">
      
        
        <link rel="stylesheet" href="../assets/stylesheets/palette.06af60db.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    
    
    
    
    
    <body dir="ltr" data-md-color-scheme="default" data-md-color-primary="black" data-md-color-accent="indigo">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#building-a-serverless-web-scraper-with-layers-dynamo-db-sns-and-event-bridge" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Lambda Forge" class="md-header__button md-logo" aria-label="Lambda Forge" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Lambda Forge
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Building A Serverless Web Scraper with Layers, Dynamo DB, SNS and Event Bridge
            
          </span>
        </div>
      </div>
    </div>
    
      
    
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Lambda Forge" class="md-nav__button md-logo" aria-label="Lambda Forge" data-md-component="logo">
      
  <img src="../images/logo.png" alt="logo">

    </a>
    Lambda Forge
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Introduction
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../page2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Getting Started
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../page3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Generating Docs
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../page4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Private Endpoints
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../page5/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Building A Serverless CRUD Application With Dynamo DB
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  <span class="md-ellipsis">
    Building A Serverless Web Scraper with Layers, Dynamo DB, SNS and Event Bridge
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  <span class="md-ellipsis">
    Building A Serverless Web Scraper with Layers, Dynamo DB, SNS and Event Bridge
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dynamo-db" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamo DB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lambda-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Layers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lambda Layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-are-lambda-layers" class="md-nav__link">
    <span class="md-ellipsis">
      What Are Lambda Layers?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incorporating-layers-into-our-service-class" class="md-nav__link">
    <span class="md-ellipsis">
      Incorporating Layers Into Our Service Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incorporating-requests-and-beautiful-soup-via-public-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Incorporating Requests and Beautiful Soup via Public Layers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#developing-the-web-scraper" class="md-nav__link">
    <span class="md-ellipsis">
      Developing The Web Scraper
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Developing The Web Scraper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-web-scraper-with-pagination-handling-using-a-while-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Web Scraper with Pagination Handling Using a While Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-web-scraper-with-pagination-handling-using-sns" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Web Scraper with Pagination Handling Using SNS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-the-web-scraper" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring The Web Scraper
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduling-executions-with-event-bridge" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduling Executions With Event Bridge
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#developing-an-endpoint-for-data-access" class="md-nav__link">
    <span class="md-ellipsis">
      Developing an Endpoint for Data Access
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#launching-our-web-scraper-and-data-visualization-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Launching Our Web Scraper and Data Visualization Endpoint
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#dynamo-db" class="md-nav__link">
    <span class="md-ellipsis">
      Dynamo DB
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#lambda-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Lambda Layers
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Lambda Layers">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#what-are-lambda-layers" class="md-nav__link">
    <span class="md-ellipsis">
      What Are Lambda Layers?
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incorporating-layers-into-our-service-class" class="md-nav__link">
    <span class="md-ellipsis">
      Incorporating Layers Into Our Service Class
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#incorporating-requests-and-beautiful-soup-via-public-layers" class="md-nav__link">
    <span class="md-ellipsis">
      Incorporating Requests and Beautiful Soup via Public Layers
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#developing-the-web-scraper" class="md-nav__link">
    <span class="md-ellipsis">
      Developing The Web Scraper
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Developing The Web Scraper">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#building-a-web-scraper-with-pagination-handling-using-a-while-loop" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Web Scraper with Pagination Handling Using a While Loop
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#building-a-web-scraper-with-pagination-handling-using-sns" class="md-nav__link">
    <span class="md-ellipsis">
      Building a Web Scraper with Pagination Handling Using SNS
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#configuring-the-web-scraper" class="md-nav__link">
    <span class="md-ellipsis">
      Configuring The Web Scraper
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#scheduling-executions-with-event-bridge" class="md-nav__link">
    <span class="md-ellipsis">
      Scheduling Executions With Event Bridge
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#developing-an-endpoint-for-data-access" class="md-nav__link">
    <span class="md-ellipsis">
      Developing an Endpoint for Data Access
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#launching-our-web-scraper-and-data-visualization-endpoint" class="md-nav__link">
    <span class="md-ellipsis">
      Launching Our Web Scraper and Data Visualization Endpoint
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


<h1 id="building-a-serverless-web-scraper-with-layers-dynamo-db-sns-and-event-bridge">Building A Serverless Web Scraper with Layers, Dynamo DB, SNS and Event Bridge</h1>
<p>It's time to elevate our tutorial to the next level.</p>
<p>In this section, we will develop a serverless web scraper designed to extract informations about books from <a href="https://books.toscrape.com/">https://books.toscrape.com/</a> utilizing the Requests library and Beautiful Soup. The retrieved data will be stored in DynamoDB, enabling us to perform queries via an endpoint.</p>
<p>Additionally, we will cover how to configure our Lambda function to execute daily, ensuring our dataset remains current and accurate.</p>
<h2 id="dynamo-db">Dynamo DB</h2>
<p>Considering the write access to our database will be exclusively reserved for the scraper, maintaining three separate databases for each deployment stage is unnecessary. Therefore, let's just create a singular DynamoDB table designed to serve all three environments uniformly.</p>
<p>Instead of setting up each environment's details separately in the <code>cdk.json</code> file, like we did to the users table, we'll make things simpler by creating a single Books table on the AWS console and placing its ARN directly into our DynamoDB class.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/services/dynamo_db.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 5</span>
<span class="normal"> 6</span>
<span class="normal"> 7</span>
<span class="normal"> 8</span>
<span class="normal"> 9</span>
<span class="normal">10</span>
<span class="normal">11</span>
<span class="normal">12</span>
<span class="normal">13</span>
<span class="normal">14</span>
<span class="normal">15</span>
<span class="normal">16</span>
<span class="normal">17</span>
<span class="normal">18</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">class</span> <span class="nc">DynamoDB</span><span class="p">:</span>
  <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">resources</span><span class="p">:</span> <span class="nb">dict</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

      <span class="bp">self</span><span class="o">.</span><span class="n">users_table</span> <span class="o">=</span> <span class="n">dynamo_db</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_table_arn</span><span class="p">(</span>
          <span class="n">scope</span><span class="p">,</span>
          <span class="s2">&quot;UsersTable&quot;</span><span class="p">,</span>
          <span class="n">resources</span><span class="p">[</span><span class="s2">&quot;arns&quot;</span><span class="p">][</span><span class="s2">&quot;users_table&quot;</span><span class="p">],</span>
      <span class="p">)</span>

<span class="hll">      <span class="bp">self</span><span class="o">.</span><span class="n">books_table</span> <span class="o">=</span> <span class="n">dynamo_db</span><span class="o">.</span><span class="n">Table</span><span class="o">.</span><span class="n">from_table_arn</span><span class="p">(</span>
</span><span class="hll">          <span class="n">scope</span><span class="p">,</span>
</span><span class="hll">          <span class="s2">&quot;BooksTable&quot;</span><span class="p">,</span>
</span><span class="hll">          <span class="s2">&quot;$BOOKS-TABLE-ARN&quot;</span><span class="p">,</span>
</span><span class="hll">      <span class="p">)</span>
</span></code></pre></div></td></tr></table></div>
<h2 id="lambda-layers">Lambda Layers</h2>
<p>Another essential aspect of our project involves leveraging external libraries like <code>requests</code> and <code>Beautiful Soup</code> for our web scraping tasks. Since these libraries are not built into Python's standard library, we'll need to incorporate them into our AWS Lambda functions as Lambda Layers.</p>
<h3 id="what-are-lambda-layers">What Are Lambda Layers?</h3>
<p>Lambda Layers are essentially ZIP archives containing libraries, custom runtime environments, or other dependencies. You can include these layers in your Lambda function’s execution environment without having to bundle them directly with your function's deployment package. This means you can use libraries or custom runtimes across multiple Lambda functions without needing to include them in each function’s codebase.</p>
<h3 id="incorporating-layers-into-our-service-class">Incorporating Layers Into Our Service Class</h3>
<p>Just as we previously set up our DynamoDB Service Class, it's now time to integrate the Lambda Layers into our Service Class using Forge. To accomplish this, simply execute the following command:</p>
<p><code>forge service layers</code></p>
<p>A new <code>layers.py</code> file has been created on <code>infra/services</code> and automatically incorporated into our Services class. This convenience allows us to focus more on development and less on configuration.</p>
<div class="highlight"><pre><span></span><code>infra
├── services
    ├── __init__.py
    ├── api_gateway.py
    ├── aws_lambda.py
    ├── dynamo_db.py
    └── layers.py
</code></pre></div>
<div class="highlight"><span class="filename">infra/services/__init__.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">infra.services.layers</span> <span class="kn">import</span> <span class="n">Layers</span>
<span class="kn">from</span> <span class="nn">infra.services.dynamo_db</span> <span class="kn">import</span> <span class="n">DynamoDB</span>
<span class="kn">from</span> <span class="nn">infra.services.api_gateway</span> <span class="kn">import</span> <span class="n">APIGateway</span>
<span class="kn">from</span> <span class="nn">infra.services.aws_lambda</span> <span class="kn">import</span> <span class="n">AWSLambda</span>


<span class="k">class</span> <span class="nc">Services</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">api_gateway</span> <span class="o">=</span> <span class="n">APIGateway</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">aws_lambda</span> <span class="o">=</span> <span class="n">AWSLambda</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamo_db</span> <span class="o">=</span> <span class="n">DynamoDB</span><span class="p">(</span><span class="n">scope</span><span class="p">,</span> <span class="n">context</span><span class="o">.</span><span class="n">resources</span><span class="p">)</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">layers</span> <span class="o">=</span> <span class="n">Layers</span><span class="p">(</span><span class="n">scope</span><span class="p">)</span>
</span></code></pre></div>
<h3 id="incorporating-requests-and-beautiful-soup-via-public-layers">Incorporating Requests and Beautiful Soup via Public Layers</h3>
<p>The <code>requests</code> and <code>Beautiful Soup</code> libraries are widely used and recognized for their utility in web scraping and data extraction tasks. Fortunately, AWS Lambda offers these libraries as public layers, simplifying the process of integrating them into your projects without the need to create custom layers.</p>
<p>For projects utilizing Python 3.9, we can leverage the specific Amazon Resource Names (ARNs) for both requests and Beautiful Soup libraries made available through Klayers. This provides an efficient way to add these libraries to your Lambda functions. You can explore the complete list of public layers for Python 3.9 in the <code>us-east-2</code> region <a href="https://api.klayers.cloud//api/v2/p3.9/layers/latest/us-east-2/json">here</a>.</p>
<p>Here are the ARNs you'll need:</p>
<ul>
<li>
<p>Requests: <code>arn:aws:lambda:us-east-2:770693421928:layer:Klayers-p39-requests:19</code></p>
</li>
<li>
<p>Beautiful Soup 4: <code>arn:aws:lambda:us-east-2:770693421928:layer:Klayers-p39-beautifulsoup4:7</code></p>
</li>
</ul>
<p>Let's add them both to our Layers class.</p>
<div class="highlight"><span class="filename">infra/services/layers.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_cdk</span> <span class="kn">import</span> <span class="n">aws_lambda</span> <span class="k">as</span> <span class="n">_lambda</span>


<span class="k">class</span> <span class="nc">Layers</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">requests_layer</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">LayerVersion</span><span class="o">.</span><span class="n">from_layer_version_arn</span><span class="p">(</span>
</span><span class="hll">            <span class="n">scope</span><span class="p">,</span>
</span><span class="hll">            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;RequestsLayer&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="n">layer_version_arn</span><span class="o">=</span><span class="s2">&quot;arn:aws:lambda:us-east-2:770693421928:layer:Klayers-p39-requests:19&quot;</span><span class="p">,</span>
</span><span class="hll">        <span class="p">)</span>
</span>
<span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">bs4_layer</span> <span class="o">=</span> <span class="n">_lambda</span><span class="o">.</span><span class="n">LayerVersion</span><span class="o">.</span><span class="n">from_layer_version_arn</span><span class="p">(</span>
</span><span class="hll">            <span class="n">scope</span><span class="p">,</span>
</span><span class="hll">            <span class="nb">id</span><span class="o">=</span><span class="s2">&quot;BS4Layer&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="n">layer_version_arn</span><span class="o">=</span><span class="s2">&quot;arn:aws:lambda:us-east-2:770693421928:layer:Klayers-p39-beautifulsoup4:7&quot;</span><span class="p">,</span>
</span><span class="hll">        <span class="p">)</span>
</span></code></pre></div>
<p>Additionally, include the libraries in the <code>requirements.txt</code> file to ensure they are installed during the pipeline execution process.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">requirements.txt</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">16</span>
<span class="normal">17</span></pre></div></td><td class="code"><div><pre><span></span><code>requests==2.28.1
beautifulsoup4==4.12.3
</code></pre></div></td></tr></table></div>
<h2 id="developing-the-web-scraper">Developing The Web Scraper</h2>
<p>Our web scraper will extract the following details: <code>upc</code>, <code>title</code>, <code>price</code>, <code>category</code>, <code>stock</code>, <code>description</code> and <code>url</code>.</p>
<p>Let's create it with forge.</p>
<div class="highlight"><pre><span></span><code>forge function scraper --description &quot;Web scraper to populate Dynamo with books data&quot; --no-api --belongs books
</code></pre></div>
<p>Remember, although users can access the scraper's results, the scraper itself won't serve as a direct endpoint. We've included the <code>--no-api</code> flag in our Forge setup to signify that this function won't be connected to the API Gateway. Its primary role is to enrich our database. Additionally, the <code>--belongs</code> flag was used to organize it within the <code>books</code> directory, aligning it with related functions planned for the future.</p>
<p>Here is the structure created for the books directory:</p>
<div class="highlight"><pre><span></span><code>functions
├── books
   ├── scraper
   │   ├── __init__.py
   │   ├── config.py
   │   ├── main.py
   │   └── unit.py
   └── utils
       └── __init__.py
</code></pre></div>
<h3 id="building-a-web-scraper-with-pagination-handling-using-a-while-loop">Building a Web Scraper with Pagination Handling Using a While Loop</h3>
<p>Our focus is on understanding how AWS resources are integrated with Lambda Forge, not on the intricacies of developing a web scraper. Therefore, we will not cover the source code in detail. Nevertheless, we encourage you to experiment with creating your own web scraper, as the core concepts we're discussing will remain applicable.</p>
<p>Below, you'll find the source code accompanied by comments that explain the concepts it illustrates.</p>
<div class="highlight"><span class="filename">functions/books/scraper/main.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://books.toscrape.com&quot;</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>

    <span class="c1"># DynamoDB table name for storing books information</span>
    <span class="n">BOOKS_TABLE_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BOOKS_TABLE_NAME&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize a DynamoDB resource</span>
    <span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>

    <span class="c1"># Reference the DynamoDB table</span>
    <span class="n">books_table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">BOOKS_TABLE_NAME</span><span class="p">)</span>

    <span class="c1"># Determine the URL to scrape, defaulting to BASE_URL</span>
    <span class="n">url</span> <span class="o">=</span> <span class="n">event</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;url&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">BASE_URL</span>

    <span class="k">while</span> <span class="n">url</span><span class="p">:</span>
        <span class="c1"># Fetch and parse the webpage at the given URL</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">):</span>
            <span class="c1"># Extract book details</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;price_color&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">get_text</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># Correct the href if it doesn&#39;t contain &quot;catalogue/&quot;</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;catalogue/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">href</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;catalogue/</span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Fetch and parse the book detail page</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">detail_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
            <span class="n">detail_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">detail_response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

            <span class="c1"># Extract additional details from the book detail page</span>
            <span class="n">upc</span> <span class="o">=</span> <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;UPC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">category</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ul&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;breadcrumb&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">stock</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;instock availability&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">stock</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">stock</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;product_description&quot;</span><span class="p">})</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>

            <span class="c1"># Construct the item to store in DynamoDB</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="n">upc</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;stock&quot;</span><span class="p">:</span> <span class="n">stock</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Store the item in DynamoDB</span>
            <span class="n">books_table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Check for and process the next page</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;next&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="n">next_page</span><span class="p">:</span>
            <span class="n">next_href</span> <span class="o">=</span> <span class="n">next_page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="s2">&quot;catalogue/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">next_href</span><span class="p">:</span>
                <span class="n">next_href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;catalogue/</span><span class="si">{</span><span class="n">next_href</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">next_href</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">url</span> <span class="o">=</span> <span class="kc">None</span>
</code></pre></div>
<p>Due to AWS's predefined operational constraints, Lambda functions are explicitly engineered for rapid execution, with a maximum duration limit of <strong>15 minutes</strong>.</p>
<p>To evaluate the efficiency of our function, we will incorporate print statements that monitor execution time throughout our local testing phase.</p>
<div class="highlight"><pre><span></span><code>Execution time: 1024.913999080658 seconds
</code></pre></div>
<p>The execution time approaches nearly <strong>17 minutes</strong>, exceeding the maximum duration allowed for a Lambda function. Consequently, we need to seek alternative strategies to ensure our scraper remains compliant with the limitations.</p>
<p>Utilizing a while loop within a solitary AWS Lambda function to perform book data extraction from the website is functional yet lacks efficiency and scalability. This is particularly pertinent within the AWS ecosystem, which is rich in services tailored for distributed computing and intricate task orchestration.</p>
<h3 id="building-a-web-scraper-with-pagination-handling-using-sns">Building a Web Scraper with Pagination Handling Using SNS</h3>
<p>Amazon Simple Notification Service (SNS) is a fully managed messaging service provided by AWS, enabling seamless communication between distributed systems. It operates on a publish-subscribe model, where messages are published to topics and subscribers receive notifications from these topics. With support for various types of subscriptions including HTTP, SQS, Lambda, email, and SMS, SNS ensures reliable and scalable message delivery across multiple AWS regions. It also offers features like message filtering, retry mechanisms, and dead-letter queues to enhance message processing and system resilience.</p>
<p>Instead of using a while loop to process all pages in a single function, let's design a Lambda function to process a maximum of 10 pages. After completing these pages, it should dispatch a message with the URL of the next starting page to an SNS topic. This triggers another Lambda function dedicated to harvesting book information from the subsequent 10 pages.</p>
<p>As an initial step, we have to integrate SNS into our Services class.</p>
<div class="highlight"><pre><span></span><code>forge service sns
</code></pre></div>
<p>A new <code>sns.py</code> file was created on <code>infra/services</code>, so create a new SNS topic on the AWS console and place it's ARN on the SNS class.</p>
<div class="highlight"><span class="filename">infra/services/sns.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">aws_cdk</span> <span class="kn">import</span> <span class="n">aws_lambda_event_sources</span>
<span class="kn">import</span> <span class="nn">aws_cdk.aws_sns</span> <span class="k">as</span> <span class="nn">sns</span>


<span class="k">class</span> <span class="nc">SNS</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>
<span class="hll">
</span><span class="hll">        <span class="bp">self</span><span class="o">.</span><span class="n">books_scraper_topic</span> <span class="o">=</span> <span class="n">sns</span><span class="o">.</span><span class="n">Topic</span><span class="o">.</span><span class="n">from_topic_arn</span><span class="p">(</span>
</span><span class="hll">            <span class="n">scope</span><span class="p">,</span>
</span><span class="hll">            <span class="s2">&quot;BooksScraperTopic&quot;</span><span class="p">,</span>
</span><span class="hll">            <span class="n">topic_arn</span><span class="o">=</span><span class="s2">&quot;$TOPIC-ARN&quot;</span><span class="p">,</span>
</span><span class="hll">        <span class="p">)</span>
</span>
    <span class="k">def</span> <span class="nf">create_trigger</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">topic</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stages</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">sns_subscription</span> <span class="o">=</span> <span class="n">aws_lambda_event_sources</span><span class="o">.</span><span class="n">SnsEventSource</span><span class="p">(</span><span class="n">topic</span><span class="p">)</span>
        <span class="n">function</span><span class="o">.</span><span class="n">add_event_source</span><span class="p">(</span><span class="n">sns_subscription</span><span class="p">)</span>
</code></pre></div>
<p>Note that the SNS class contains a handy helper method, streamlining the process of establishing triggers that connect an SNS topic to a Lambda function.</p>
<p>Now, let's revise the original code to eliminate the while loop that processes all pages and instead publish a message to SNS containing the URL of the new starting point.</p>
<div class="highlight"><span class="filename">functions/books/scraper/main.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">time</span>
<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">bs4</span> <span class="kn">import</span> <span class="n">BeautifulSoup</span>

<span class="n">BASE_URL</span> <span class="o">=</span> <span class="s2">&quot;https://books.toscrape.com&quot;</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># Get the DynamoDB table name and SNS topic ARN from environment variables.</span>
    <span class="n">BOOKS_TABLE_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;BOOKS_TABLE_NAME&quot;</span><span class="p">,</span> <span class="s2">&quot;Books&quot;</span><span class="p">)</span>
    <span class="n">SNS_TOPIC_ARN</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;SNS_TOPIC_ARN&quot;</span><span class="p">)</span>

    <span class="c1"># Initialize the DynamoDB and SNS clients.</span>
    <span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>
    <span class="n">sns</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">client</span><span class="p">(</span><span class="s2">&quot;sns&quot;</span><span class="p">)</span>

    <span class="c1"># Reference the DynamoDB table.</span>
    <span class="n">books_table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">BOOKS_TABLE_NAME</span><span class="p">)</span>

    <span class="c1"># Determine the URL to scrape, defaulting to BASE_URL</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">event</span><span class="p">[</span><span class="s1">&#39;Records&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">][</span><span class="s1">&#39;Sns&#39;</span><span class="p">][</span><span class="s1">&#39;Message&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;&#39;&quot;</span><span class="p">,</span> <span class="s1">&#39;&quot;&#39;</span><span class="p">))[</span><span class="s2">&quot;url&quot;</span><span class="p">]</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">BASE_URL</span>

    <span class="c1"># Keep track of the number of pages processed</span>
    <span class="n">pages_processed</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># Maximum number of pages to process</span>
    <span class="n">MAX_PAGES</span> <span class="o">=</span> <span class="mi">10</span>

    <span class="k">while</span> <span class="n">pages_processed</span> <span class="o">&lt;</span> <span class="n">MAX_PAGES</span><span class="p">:</span>
        <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">)</span>
        <span class="n">soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">article</span> <span class="ow">in</span> <span class="n">soup</span><span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;article&quot;</span><span class="p">):</span>
            <span class="c1"># Extract book details</span>
            <span class="n">title</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;title&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">title</span><span class="p">()</span>
            <span class="n">price</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;price_color&quot;</span><span class="p">})</span><span class="o">.</span><span class="n">get_text</span><span class="p">()[</span><span class="mi">1</span><span class="p">:]</span>

            <span class="c1"># Correct the href if it doesn&#39;t contain &quot;catalogue/&quot;</span>
            <span class="n">href</span> <span class="o">=</span> <span class="n">article</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;h3&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;href&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;catalogue/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">href</span><span class="p">:</span>
                <span class="n">href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;catalogue/</span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span>

            <span class="c1"># Fetch and parse the book detail page</span>
            <span class="n">detail_url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">href</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">detail_response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">detail_url</span><span class="p">)</span>
            <span class="n">detail_soup</span> <span class="o">=</span> <span class="n">BeautifulSoup</span><span class="p">(</span><span class="n">detail_response</span><span class="o">.</span><span class="n">text</span><span class="p">,</span> <span class="s2">&quot;html.parser&quot;</span><span class="p">)</span>

            <span class="c1"># Extract additional details from the book detail page</span>
            <span class="n">upc</span> <span class="o">=</span> <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;th&quot;</span><span class="p">,</span> <span class="n">string</span><span class="o">=</span><span class="s2">&quot;UPC&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;td&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="n">category</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;ul&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">,</span> <span class="s2">&quot;breadcrumb&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">find_all</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">)[</span><span class="mi">2</span><span class="p">]</span>
                <span class="o">.</span><span class="n">text</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">description</span> <span class="o">=</span> <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;div&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="s2">&quot;product_description&quot;</span><span class="p">})</span>
            <span class="n">stock</span> <span class="o">=</span> <span class="p">(</span>
                <span class="n">detail_soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;instock availability&quot;</span><span class="p">})</span>
                <span class="o">.</span><span class="n">get_text</span><span class="p">()</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
            <span class="p">)</span>
            <span class="n">stock</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\d+&quot;</span><span class="p">,</span> <span class="n">stock</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">description</span><span class="p">:</span>
                <span class="n">description</span> <span class="o">=</span> <span class="n">description</span><span class="o">.</span><span class="n">find_next</span><span class="p">(</span><span class="s2">&quot;p&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">get_text</span><span class="p">()</span>

            <span class="c1"># Construct the item to store in DynamoDB</span>
            <span class="n">item</span> <span class="o">=</span> <span class="p">{</span>
                <span class="s2">&quot;PK&quot;</span><span class="p">:</span> <span class="n">upc</span><span class="p">,</span>
                <span class="s2">&quot;category&quot;</span><span class="p">:</span> <span class="n">category</span><span class="p">,</span>
                <span class="s2">&quot;title&quot;</span><span class="p">:</span> <span class="n">title</span><span class="p">,</span>
                <span class="s2">&quot;price&quot;</span><span class="p">:</span> <span class="n">price</span><span class="p">,</span>
                <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="n">description</span><span class="p">,</span>
                <span class="s2">&quot;stock&quot;</span><span class="p">:</span> <span class="n">stock</span><span class="p">,</span>
                <span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">detail_url</span><span class="p">,</span>
            <span class="p">}</span>

            <span class="c1"># Store the item in DynamoDB</span>
            <span class="n">books_table</span><span class="o">.</span><span class="n">put_item</span><span class="p">(</span><span class="n">Item</span><span class="o">=</span><span class="n">item</span><span class="p">)</span>

        <span class="c1"># Increment the number of pages processed</span>
        <span class="n">pages_processed</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="c1"># Check for the next page</span>
        <span class="n">next_page</span> <span class="o">=</span> <span class="n">soup</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;li&quot;</span><span class="p">,</span> <span class="p">{</span><span class="s2">&quot;class&quot;</span><span class="p">:</span> <span class="s2">&quot;next&quot;</span><span class="p">})</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">next_page</span><span class="p">:</span>
            <span class="k">break</span>

        <span class="c1"># Correct the href if it doesn&#39;t contain &quot;catalogue/&quot;</span>
        <span class="n">next_href</span> <span class="o">=</span> <span class="n">next_page</span><span class="o">.</span><span class="n">find</span><span class="p">(</span><span class="s2">&quot;a&quot;</span><span class="p">)[</span><span class="s2">&quot;href&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;catalogue/&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">next_href</span><span class="p">:</span>
            <span class="n">next_href</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;catalogue/</span><span class="si">{</span><span class="n">next_href</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="c1"># Construct the URL for the next page</span>
        <span class="n">url</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">BASE_URL</span><span class="si">}</span><span class="s2">/</span><span class="si">{</span><span class="n">next_href</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">if</span> <span class="n">next_page</span><span class="p">:</span>
        <span class="c1"># Publish a message to the SNS topic to process the next 10 pages</span>
        <span class="n">sns</span><span class="o">.</span><span class="n">publish</span><span class="p">(</span>
            <span class="n">TopicArn</span><span class="o">=</span><span class="n">SNS_TOPIC_ARN</span><span class="p">,</span>
            <span class="n">Message</span><span class="o">=</span><span class="nb">str</span><span class="p">({</span><span class="s2">&quot;url&quot;</span><span class="p">:</span> <span class="n">url</span><span class="p">}),</span>
            <span class="n">Subject</span><span class="o">=</span><span class="sa">f</span><span class="s2">&quot;Process next </span><span class="si">{</span><span class="n">MAX_PAGES</span><span class="si">}</span><span class="s2"> pages of books&quot;</span><span class="p">,</span>
        <span class="p">)</span>
</code></pre></div>
<p>Let's measure how long that function took to run locally:</p>
<div class="highlight"><pre><span></span><code>Execution time: 167.53530287742615 seconds
</code></pre></div>
<p>Fantastic, it took under <strong>3 minutes</strong>!</p>
<p>This approach ensures that we never exceed the 15 minutes timeout limit, as each time a new message is published to SNS, the timeout counter is refreshed, allowing continuous execution without interruption.</p>
<h2 id="configuring-the-web-scraper">Configuring The Web Scraper</h2>
<p>Now that we have developed our function, let's proceed to configure the necessary AWS resources for its executions on the cloud.</p>
<div class="highlight"><span class="filename">functions/books/scraper/config.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">infra.services</span> <span class="kn">import</span> <span class="n">Services</span>


<span class="k">class</span> <span class="nc">ScraperConfig</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">services</span><span class="p">:</span> <span class="n">Services</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">function</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">aws_lambda</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Scraper&quot;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./functions/books&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Web scraper to populate Dynamo with books data&quot;</span><span class="p">,</span>
            <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;scraper&quot;</span><span class="p">,</span>
<span class="hll">            <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
</span><span class="hll">            <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">services</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">requests_layer</span><span class="p">,</span> <span class="n">services</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">bs4_layer</span><span class="p">],</span>
</span><span class="hll">            <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
</span><span class="hll">                <span class="s2">&quot;BOOKS_TABLE_NAME&quot;</span><span class="p">:</span> <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">books_table</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
</span><span class="hll">                <span class="s2">&quot;SNS_TOPIC_ARN&quot;</span><span class="p">:</span> <span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">books_scraper_topic</span><span class="o">.</span><span class="n">topic_arn</span>
</span><span class="hll">            <span class="p">}</span>
</span>        <span class="p">)</span>

<span class="hll">        <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">books_table</span><span class="o">.</span><span class="n">grant_write_data</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
</span>
<span class="hll">        <span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">create_trigger</span><span class="p">(</span><span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">books_scraper_topic</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
</span><span class="hll">        <span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">books_scraper_topic</span><span class="o">.</span><span class="n">grant_publish</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
</span></code></pre></div>
<p>This configuration file outlines the setup and permissions for a Lambda function, detailing:</p>
<ul>
<li><strong>Timeout:</strong> Specifies a maximum duration of 5 minutes for Lambda execution.</li>
<li><strong>Layers:</strong> Adds the requests and bs4 layers to the Lambda function.</li>
<li><strong>Environment Variables:</strong> Establishes the required environment variables for operation.</li>
<li><strong>DynamoDB Access:</strong> Provides the Lambda function with write access to the DynamoDB Books table.</li>
<li><strong>SNS Trigger:</strong> Utilizes the SNS class helper method to link an SNS topic with the production Lambda function.</li>
<li><strong>SNS Publishing Permissions:</strong> Empowers the Lambda function to publish messages to the books topic.</li>
</ul>
<h2 id="scheduling-executions-with-event-bridge">Scheduling Executions With Event Bridge</h2>
<p>The current configuration file equips us to execute the Lambda function as needed. However, it necessitates manual intervention for each run, which is an impractical approach for dynamic tasks like web scraping. The crux of the issue lies in the volatile nature of our target: website data, such as book prices and inventory, can change unpredictably.</p>
<p>To mitigate this, we must ensure our web scraper operates automatically at regular intervals, thus capturing updates without manual oversight. By leveraging AWS EventBridge, we can schedule our Lambda function to run periodically, ensuring our data collection remains current with minimal effort.</p>
<p>To integrate AWS EventBridge for scheduling tasks, we begin by creating an EventBridge class using Forge. This is achieved with the following command:</p>
<div class="highlight"><pre><span></span><code>forge service event_bridge
</code></pre></div>
<p>After executing the command, a new file named <code>event_bridge.py</code> is generated within the <code>infra/services</code> directory. Let's explore its contents and functionalities:</p>
<div class="highlight"><span class="filename">infra/services/event_bridge.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">aws_cdk.aws_events</span> <span class="k">as</span> <span class="nn">events</span>
<span class="kn">import</span> <span class="nn">aws_cdk.aws_events_targets</span> <span class="k">as</span> <span class="nn">targets</span>


<span class="k">class</span> <span class="nc">EventBridge</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">scope</span><span class="p">,</span> <span class="n">resources</span><span class="p">,</span> <span class="n">stage</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">scope</span> <span class="o">=</span> <span class="n">scope</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="o">=</span> <span class="n">stage</span>

    <span class="k">def</span> <span class="nf">create_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">expression</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">stages</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">stages</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">stage</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">stages</span><span class="p">:</span>
            <span class="k">return</span>
        <span class="n">events</span><span class="o">.</span><span class="n">Rule</span><span class="p">(</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">scope</span><span class="p">,</span>
            <span class="n">name</span><span class="p">,</span>
            <span class="n">schedule</span><span class="o">=</span><span class="n">events</span><span class="o">.</span><span class="n">Schedule</span><span class="o">.</span><span class="n">expression</span><span class="p">(</span><span class="n">expression</span><span class="p">),</span>
            <span class="n">targets</span><span class="o">=</span><span class="p">[</span><span class="n">targets</span><span class="o">.</span><span class="n">LambdaFunction</span><span class="p">(</span><span class="n">handler</span><span class="o">=</span><span class="n">target</span><span class="p">)],</span>
        <span class="p">)</span>
</code></pre></div>
<p>This class introduces a streamlined method for creating EventBridge rules, enabling the scheduling of Lambda function executions.</p>
<p>Before we proceed, it's crucial to acknowledge that we're operating within a multi-stage deployment environment. Our immediate task involves configuring the Scraper function to activate based on a scheduled rule. However, a pertinent question arises: Should we initiate the triggering of three distinct functions simultaneously? Of course not, especially when considering efficiency and resource management. More precisely, is there a need for three separate scrapers when, in reality, only one scraper is destined for activation?</p>
<p>Bearing this consideration in mind, it's wise to implement a few minor adjustments. Our goal is to streamline the process, thereby avoiding the unnecessary creation of unused scrapers.</p>
<p>First, let's modify the <code>LambdaStack</code> class to send also the context to the <code>ScraperConfig</code> class.</p>
<div class="highlight"><table class="highlighttable"><tr><th colspan="2" class="filename"><span class="filename">infra/stacks/lambda_stack.py</span></th></tr><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">42</span>
<span class="normal">43</span></pre></div></td><td class="code"><div><pre><span></span><code>        <span class="c1"># Books</span>
        <span class="n">ScraperConfig</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">services</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span>
</code></pre></div></td></tr></table></div>
<p>Now, let's modify our configuration class to accept the <code>context</code> as an additional argument in its constructor.</p>
<p>By incorporating the context, we can strategically condition the creation of the function based on the deployment stage.</p>
<div class="highlight"><span class="filename">functions/books/scraper/config.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">infra.services</span> <span class="kn">import</span> <span class="n">Services</span>


<span class="k">class</span> <span class="nc">ScraperConfig</span><span class="p">:</span>
<span class="hll">    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">services</span><span class="p">:</span> <span class="n">Services</span><span class="p">,</span> <span class="n">context</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
</span>
<span class="hll">        <span class="k">if</span> <span class="n">context</span><span class="o">.</span><span class="n">stage</span> <span class="o">==</span> <span class="s2">&quot;Prod&quot;</span><span class="p">:</span>
</span>          <span class="n">function</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">aws_lambda</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span>
              <span class="n">name</span><span class="o">=</span><span class="s2">&quot;Scraper&quot;</span><span class="p">,</span>
              <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./functions/books&quot;</span><span class="p">,</span>
              <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Web scraper to populate Dynamo with books data&quot;</span><span class="p">,</span>
              <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;scraper&quot;</span><span class="p">,</span>
              <span class="n">timeout</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span>
              <span class="n">layers</span><span class="o">=</span><span class="p">[</span><span class="n">services</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">requests_layer</span><span class="p">,</span> <span class="n">services</span><span class="o">.</span><span class="n">layers</span><span class="o">.</span><span class="n">bs4_layer</span><span class="p">],</span>
              <span class="n">environment</span><span class="o">=</span><span class="p">{</span>
                  <span class="s2">&quot;BOOKS_TABLE_NAME&quot;</span><span class="p">:</span> <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">books_table</span><span class="o">.</span><span class="n">table_name</span><span class="p">,</span>
                  <span class="s2">&quot;SNS_TOPIC_ARN&quot;</span><span class="p">:</span> <span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">books_scraper_topic</span><span class="o">.</span><span class="n">topic_arn</span>
              <span class="p">}</span>
          <span class="p">)</span>

          <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">books_table</span><span class="o">.</span><span class="n">grant_write_data</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

          <span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">create_trigger</span><span class="p">(</span><span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">books_scraper_topic</span><span class="p">,</span> <span class="n">function</span><span class="p">)</span>
          <span class="n">services</span><span class="o">.</span><span class="n">sns</span><span class="o">.</span><span class="n">books_scraper_topic</span><span class="o">.</span><span class="n">grant_publish</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>

<span class="hll">          <span class="n">services</span><span class="o">.</span><span class="n">event_bridge</span><span class="o">.</span><span class="n">create_rule</span><span class="p">(</span>
</span><span class="hll">              <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ScraperRule&quot;</span><span class="p">,</span>
</span><span class="hll">              <span class="n">expression</span><span class="o">=</span><span class="s2">&quot;cron(0 12 ? * * *)&quot;</span><span class="p">,</span>
</span><span class="hll">              <span class="n">target</span><span class="o">=</span><span class="n">function</span><span class="p">,</span>
</span><span class="hll">          <span class="p">)</span>
</span></code></pre></div>
<p>The cron expression <code>cron(0 12 ? * * *)</code> configures a schedule to initiate an action every day at 12 PM UTC.</p>
<p>Now, we're streamlining our deployment by creating the Lambda function and its essential resources exclusively for the staging environment that will be actively utilized.</p>
<h2 id="developing-an-endpoint-for-data-access">Developing an Endpoint for Data Access</h2>
<p>Let's create an endpoint that returns all the stored data from our database or allows filtering by category, facilitating easy access and manipulation of the data.</p>
<div class="highlight"><pre><span></span><code>forge function list_books --method &quot;GET&quot; --description &quot;A function to fetch books from DynamoDB, optionally filtered by category.&quot; --belongs books --public
</code></pre></div>
<p>The file has been created within the <code>books</code> directory, as initially planned.</p>
<div class="highlight"><pre><span></span><code>functions
├── books
    ├── list_books
    │   ├── __init__.py
    │   ├── config.py
    │   ├── integration.py
    │   ├── main.py
    │   └── unit.py
    ├── scraper
    │   ├── __init__.py
    │   ├── config.py
    │   ├── main.py
    │   └── unit.py
    └── utils
        └── __init__.py
</code></pre></div>
<p>To optimize data retrieval by category from our DynamoDB table, we need to create a Global Secondary Index (GSI) on the Books Table. This index enables efficient querying and filtering of data based on the <code>category</code> attribute, without the need for scanning the entire table.</p>
<p>Go to the DynamoDB section within the AWS Management Console and select the Books Table. Click on the <code>Indexes</code> tab next to the table details, then press <code>Create index</code>. In the creation form, set the partition key to your <code>category</code> column. Name your index as <code>CategoryIndex</code>. After configuring these details, review your settings and confirm by clicking <code>Create index</code>.</p>
<p>Having established our index, we can utilize it to precisely and efficiently fetch data by category when needed, significantly optimizing our query performance.</p>
<div class="highlight"><span class="filename">functions/books/list_books/main.py</span><pre><span></span><code><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">dataclasses</span> <span class="kn">import</span> <span class="n">dataclass</span>
<span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">List</span><span class="p">,</span> <span class="n">Optional</span>

<span class="kn">import</span> <span class="nn">boto3</span>
<span class="kn">from</span> <span class="nn">boto3.dynamodb.conditions</span> <span class="kn">import</span> <span class="n">Key</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Input</span><span class="p">:</span>
    <span class="n">category</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Book</span><span class="p">:</span>
    <span class="nb">id</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">title</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">price</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">category</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">stock</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">description</span><span class="p">:</span> <span class="nb">str</span>
    <span class="n">url</span><span class="p">:</span> <span class="nb">str</span>

<span class="nd">@dataclass</span>
<span class="k">class</span> <span class="nc">Output</span><span class="p">:</span>
    <span class="n">data</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Book</span><span class="p">]</span>

<span class="k">def</span> <span class="nf">lambda_handler</span><span class="p">(</span><span class="n">event</span><span class="p">,</span> <span class="n">context</span><span class="p">):</span>
    <span class="c1"># Initialize a DynamoDB client</span>
    <span class="n">dynamodb</span> <span class="o">=</span> <span class="n">boto3</span><span class="o">.</span><span class="n">resource</span><span class="p">(</span><span class="s2">&quot;dynamodb&quot;</span><span class="p">)</span>

    <span class="c1"># Get the name of the table from the environment variable</span>
    <span class="n">BOOKS_TABLE_NAME</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s2">&quot;BOOKS_TABLE_NAME&quot;</span><span class="p">]</span>

    <span class="c1"># Create a DynamoDB table resource</span>
    <span class="n">table</span> <span class="o">=</span> <span class="n">dynamodb</span><span class="o">.</span><span class="n">Table</span><span class="p">(</span><span class="n">BOOKS_TABLE_NAME</span><span class="p">)</span>

    <span class="c1"># Check if a category is specified in the query string parameters</span>
    <span class="n">category</span> <span class="o">=</span> <span class="p">(</span>
        <span class="n">event</span><span class="p">[</span><span class="s2">&quot;queryStringParameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">event</span><span class="p">[</span><span class="s2">&quot;queryStringParameters&quot;</span><span class="p">]</span>
        <span class="k">else</span> <span class="kc">None</span>
    <span class="p">)</span>

    <span class="n">processed_items</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="n">last_evaluated_key</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Handle pagination</span>
    <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">scan_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="n">scan_kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">({</span>
                <span class="s1">&#39;IndexName&#39;</span><span class="p">:</span> <span class="s2">&quot;CategoryIndex&quot;</span><span class="p">,</span>
                <span class="s1">&#39;KeyConditionExpression&#39;</span><span class="p">:</span> <span class="n">Key</span><span class="p">(</span><span class="s2">&quot;category&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">eq</span><span class="p">(</span><span class="n">category</span><span class="o">.</span><span class="n">title</span><span class="p">())</span>
            <span class="p">})</span>

        <span class="k">if</span> <span class="n">last_evaluated_key</span><span class="p">:</span>
            <span class="n">scan_kwargs</span><span class="p">[</span><span class="s1">&#39;ExclusiveStartKey&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">last_evaluated_key</span>

        <span class="k">if</span> <span class="n">category</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">query</span><span class="p">(</span><span class="o">**</span><span class="n">scan_kwargs</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">table</span><span class="o">.</span><span class="n">scan</span><span class="p">(</span><span class="o">**</span><span class="n">scan_kwargs</span><span class="p">)</span>

        <span class="n">items</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;Items&quot;</span><span class="p">,</span> <span class="p">[])</span>

        <span class="c1"># Renaming &#39;PK&#39; attribute to &#39;id&#39; in each item</span>
        <span class="n">processed_items</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span>
            <span class="p">[{</span><span class="s2">&quot;id&quot;</span><span class="p">:</span> <span class="n">item</span><span class="p">[</span><span class="s2">&quot;PK&quot;</span><span class="p">],</span> <span class="o">**</span><span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">v</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">item</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">k</span> <span class="o">!=</span> <span class="s2">&quot;PK&quot;</span><span class="p">}}</span> <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">items</span><span class="p">]</span>
        <span class="p">)</span>

        <span class="n">last_evaluated_key</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;LastEvaluatedKey&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">last_evaluated_key</span><span class="p">:</span>
            <span class="k">break</span>

    <span class="k">return</span> <span class="p">{</span><span class="s2">&quot;statusCode&quot;</span><span class="p">:</span> <span class="mi">200</span><span class="p">,</span> <span class="s2">&quot;body&quot;</span><span class="p">:</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">({</span><span class="s2">&quot;data&quot;</span><span class="p">:</span> <span class="n">processed_items</span><span class="p">})}</span>
</code></pre></div>
<p>Now Let's configure the function</p>
<div class="highlight"><span class="filename">functions/books/list_books/config.py</span><pre><span></span><code><span class="kn">from</span> <span class="nn">infra.services</span> <span class="kn">import</span> <span class="n">Services</span>


<span class="k">class</span> <span class="nc">ListBooksConfig</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">services</span><span class="p">:</span> <span class="n">Services</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>

        <span class="n">function</span> <span class="o">=</span> <span class="n">services</span><span class="o">.</span><span class="n">aws_lambda</span><span class="o">.</span><span class="n">create_function</span><span class="p">(</span>
            <span class="n">name</span><span class="o">=</span><span class="s2">&quot;ListBooks&quot;</span><span class="p">,</span>
            <span class="n">path</span><span class="o">=</span><span class="s2">&quot;./functions/books&quot;</span><span class="p">,</span>
            <span class="n">description</span><span class="o">=</span><span class="s2">&quot;A function to fetch books from DynamoDB, optionally filtered by category.&quot;</span><span class="p">,</span>
            <span class="n">directory</span><span class="o">=</span><span class="s2">&quot;list_books&quot;</span><span class="p">,</span>
<span class="hll">            <span class="n">environment</span><span class="o">=</span><span class="p">{</span><span class="s2">&quot;BOOKS_TABLE_NAME&quot;</span><span class="p">:</span> <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">books_table</span><span class="o">.</span><span class="n">table_name</span><span class="p">},</span>
</span>        <span class="p">)</span>

        <span class="n">services</span><span class="o">.</span><span class="n">api_gateway</span><span class="o">.</span><span class="n">create_endpoint</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="s2">&quot;/books&quot;</span><span class="p">,</span> <span class="n">function</span><span class="p">,</span> <span class="n">public</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

<span class="hll">        <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">books_table</span><span class="o">.</span><span class="n">grant_read_data</span><span class="p">(</span><span class="n">function</span><span class="p">)</span>
</span><span class="hll">        <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">add_query_permission</span><span class="p">(</span>
</span><span class="hll">            <span class="n">function</span><span class="p">,</span> <span class="n">services</span><span class="o">.</span><span class="n">dynamo_db</span><span class="o">.</span><span class="n">books_table</span>
</span><span class="hll">        <span class="p">)</span>
</span></code></pre></div>
<p>In addition to the foundational setup facilitated by Forge, this configuration file plays a crucial role in further customizing our function. It specifically focuses on defining environment variables and granting read permissions to the function for accessing the Books table.</p>
<p>Moreover, we leverage a specialized helper method within our DynamoDB class to extend Query permissions to the Lambda function. This distinction is critical as querying entails more specific privileges beyond data reading, ensuring our function has the precise access needed for optimal operation.</p>
<h2 id="launching-our-web-scraper-and-data-visualization-endpoint">Launching Our Web Scraper and Data Visualization Endpoint</h2>
<p>Great, we're all set to deploy our function.</p>
<p>Now, we'll commit and push our changes to the remote repository, allowing our CI/CD pipeline to handle the deployment seamlessly.</p>
<div class="highlight"><pre><span></span><code><span class="c1"># Add changes to the staging area</span>
git<span class="w"> </span>add<span class="w"> </span>.

<span class="c1"># Commit the changes with a descriptive message</span>
git<span class="w"> </span>commit<span class="w"> </span>-m<span class="w"> </span><span class="s2">&quot;Deploying Web Scraper and Data Visualization Endpoint&quot;</span>

<span class="c1"># Push changes to the &#39;dev&#39; branch.</span>
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>dev

<span class="c1"># Switch to the &#39;staging&#39; branch, merge changes from &#39;dev&#39;, and push</span>
git<span class="w"> </span>checkout<span class="w"> </span>staging
git<span class="w"> </span>merge<span class="w"> </span>dev
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>staging

<span class="c1"># Switch to the &#39;main&#39; branch, merge changes from &#39;staging&#39;, and push</span>
git<span class="w"> </span>checkout<span class="w"> </span>main
git<span class="w"> </span>merge<span class="w"> </span>staging
git<span class="w"> </span>push<span class="w"> </span>origin<span class="w"> </span>main
</code></pre></div>
<p>Once the pipeline execution concludes, expect to see a single scraper function established.</p>
<p><img alt="alt text" src="../images/scraper.png" /></p>
<p>Additionally, this function will be configured with two distinct triggers: an SNS trigger and an Event Bridge trigger, each serving a unique purpose in the workflow.</p>
<p><img alt="alt text" src="../images/prod-scraper.png" /></p>
<p>Now we can also test new endpoints to list the scraped data.</p>
<ul>
<li>Dev: <a href="https://gxjca0e395.execute-api.us-east-2.amazonaws.com/dev/books">https://gxjca0e395.execute-api.us-east-2.amazonaws.com/dev/books</a></li>
<li>Staging: <a href="https://8kwcovaj0f.execute-api.us-east-2.amazonaws.com/staging/books">https://8kwcovaj0f.execute-api.us-east-2.amazonaws.com/staging/books</a></li>
<li>Prod: <a href="https://s6zqhu2pg1.execute-api.us-east-2.amazonaws.com/prod/books">https://s6zqhu2pg1.execute-api.us-east-2.amazonaws.com/prod/books</a></li>
</ul>
<p>Our documentation is also updated with the new books endpoint.</p>
<p><img alt="alt text" src="../images/swagger-books.png" /></p>
<ul>
<li>Staging: <a href="https://8kwcovaj0f.execute-api.us-east-2.amazonaws.com/staging/docs">https://8kwcovaj0f.execute-api.us-east-2.amazonaws.com/staging/docs</a></li>
<li>Prod: <a href="https://s6zqhu2pg1.execute-api.us-east-2.amazonaws.com/prod/docs">https://s6zqhu2pg1.execute-api.us-east-2.amazonaws.com/prod/docs</a></li>
</ul>
<p>Congratulations! 🎉 You've successfully created your first web scraper using Lambda Layers, SNS, DynamoDB and Event Bridge using Lambda Forge. 🚀</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "..", "features": [], "search": "../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../assets/javascripts/bundle.bd41221c.min.js"></script>
      
    
  </body>
</html>